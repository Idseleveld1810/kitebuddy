---
// Auth callback page voor Supabase e-mail verificatie
// Deze pagina wordt aangeroepen wanneer gebruikers op de verificatie link klikken

import { supabase } from '../../lib/supabaseClient.js';

let message = '';
let isSuccess = false;

try {
  // Haal URL parameters op
  const url = new URL(Astro.request.url);
  const token = url.searchParams.get('token');
  const type = url.searchParams.get('type');

  if (token && type === 'signup') {
    // Verificeer e-mail
    const { data, error } = await supabase.auth.verifyOtp({
      token_hash: token,
      type: 'signup'
    });

    if (error) {
      message = `Verificatie fout: ${error.message}`;
      isSuccess = false;
    } else {
      message = 'E-mail succesvol geverifieerd! Je kunt nu inloggen.';
      isSuccess = true;
    }
  } else {
    message = 'Ongeldige verificatie link.';
    isSuccess = false;
  }
} catch (error) {
  console.error('❌ Auth callback error:', error);
  message = 'Er is een fout opgetreden bij de verificatie.';
  isSuccess = false;
}
---

<html lang="nl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-mail Verificatie - Kitebuddy</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-amber-50 font-sans text-gray-800 min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-8 text-center">
      
      {isSuccess ? (
        <>
          <div class="text-6xl mb-4">✅</div>
          <h1 class="text-2xl font-bold text-gray-800 mb-4">
            E-mail Geverifieerd!
          </h1>
          <p class="text-gray-600 mb-6">
            {message}
          </p>
          <a 
            href="/" 
            class="inline-block bg-cyan-600 text-white px-6 py-3 rounded-md hover:bg-cyan-700 transition-colors font-medium"
          >
            Ga naar Kitebuddy
          </a>
        </>
      ) : (
        <>
          <div class="text-6xl mb-4">❌</div>
          <h1 class="text-2xl font-bold text-gray-800 mb-4">
            Verificatie Fout
          </h1>
          <p class="text-gray-600 mb-6">
            {message}
          </p>
          <div class="space-y-3">
            <a 
              href="/" 
              class="inline-block bg-cyan-600 text-white px-6 py-3 rounded-md hover:bg-cyan-700 transition-colors font-medium"
            >
              Ga naar Kitebuddy
            </a>
            <br>
            <a 
              href="/#login" 
              class="inline-block bg-gray-500 text-white px-6 py-3 rounded-md hover:bg-gray-600 transition-colors font-medium"
            >
              Probeer opnieuw in te loggen
            </a>
          </div>
        </>
      )}

    </div>

    <script>
      // Automatische redirect na 5 seconden
      setTimeout(() => {
        window.location.href = '/';
      }, 5000);
    </script>
  </body>
</html>
