---
import spots from "../../data/spots_with_wind_top50.json";

const { spotId, date } = Astro.params;

// Get forecast data for the specific date
let forecastData = {};
let source = 'openmeteo';

try {
  const baseUrl = Astro.url.origin;
  const apiUrl = `${baseUrl}/api/forecast?spotId=${spotId}`;
  const response = await fetch(apiUrl);

  if (response.ok) {
    const apiData = await response.json();
    forecastData = apiData.forecast || {};
    source = apiData.source || 'openmeteo';
  }
} catch (error) {
  console.error(`Failed to load data for ${spotId}:`, error);
  forecastData = {};
}

// Find spot details
const spot = spots.find(s => s.spotId === spotId);
const spotName = spot ? spot.name : spotId;

// Convert date to day name for data lookup
const dateObj = new Date(date);
const dayNames = ['zondag', 'maandag', 'dinsdag', 'woensdag', 'donderdag', 'vrijdag', 'zaterdag'];
const dayName = dayNames[dateObj.getDay()];

// Get hours for this specific day and remove duplicates
const rawHours = forecastData[dayName] || [];
const hours = rawHours.filter((hour, index, arr) => {
  // Remove duplicates based on time
  return arr.findIndex(h => h.time === hour.time) === index;
});

// Calculate chart data
const maxWind = hours.length > 0 ? Math.max(...hours.map(h => Math.round(h.speed || 0))) : 0;
const maxGust = hours.length > 0 ? Math.max(...hours.map(h => Math.round(h.gust || h.speed || 0))) : 0;
const maxValue = Math.max(maxWind, maxGust);
const scale = maxValue > 0 ? Math.ceil(maxValue / 5) * 5 : 30; // Round up to nearest 5, default to 30
const yScale = 250 / scale; // Use 250px for the chart area

// Generate smooth curves using path with cubic bezier
const windPoints = hours.map((hour, index) => {
  const x = 60 + (index * (780 / (hours.length - 1))); // More space for labels
  const windSpeed = Math.round(hour.speed || 0);
  const y = 270 - (windSpeed * yScale);
  return { x, y };
});

const gustPoints = hours.map((hour, index) => {
  const x = 60 + (index * (780 / (hours.length - 1))); // More space for labels
  const windGust = Math.round(hour.gust || hour.speed || 0);
  const y = 270 - (windGust * yScale);
  return { x, y };
});

// Create smooth path for wind speed
let windPath = `M ${windPoints[0].x} ${windPoints[0].y}`;
for (let i = 1; i < windPoints.length; i++) {
  const prev = windPoints[i - 1];
  const curr = windPoints[i];
  const cp1x = prev.x + (curr.x - prev.x) / 3;
  const cp1y = prev.y;
  const cp2x = curr.x - (curr.x - prev.x) / 3;
  const cp2y = curr.y;
  windPath += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${curr.x} ${curr.y}`;
}

// Create smooth path for wind gusts
let gustPath = `M ${gustPoints[0].x} ${gustPoints[0].y}`;
for (let i = 1; i < gustPoints.length; i++) {
  const prev = gustPoints[i - 1];
  const curr = gustPoints[i];
  const cp1x = prev.x + (curr.x - prev.x) / 3;
  const cp1y = prev.y;
  const cp2x = curr.x - (curr.x - prev.x) / 3;
  const cp2y = curr.y;
  gustPath += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${curr.x} ${curr.y}`;
}

// Format date for display
const formattedDate = dateObj.toLocaleDateString('nl-NL', {
  weekday: 'long',
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---

<html lang="nl">
  <head>
    <style is:global>
      @import "../../styles/global.css";
    </style>
    <meta charset="UTF-8" />
    <title>Kitesurf Details – {spotName} – {formattedDate}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body class="bg-amber-50 font-sans text-gray-800 min-h-screen">
    <header class="bg-cyan-700 text-white text-center p-3 sm:p-4">
      <h1 class="text-xl sm:text-2xl md:text-3xl font-semibold mb-2">
        Kitebuddy
      </h1>
      <p class="text-sm sm:text-base text-cyan-200 mb-3">
        {spotName} • {formattedDate}
      </p>
      <div class="flex justify-center gap-4">
        <a href="/" class="text-sm text-cyan-200 hover:text-white transition-colors px-3 py-1 rounded hover:bg-cyan-600">
          ← Home
        </a>
        <a href={`/${spotId}`} class="text-sm text-cyan-200 hover:text-white transition-colors px-3 py-1 rounded hover:bg-cyan-600">
          ← Week
        </a>
      </div>
    </header>

    <main class="w-full max-w-4xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6">
      {hours.length > 0 ? (
        <div class="space-y-4">
          <!-- Wind Chart -->
          <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm border border-cyan-100">
            <div class="relative h-64 sm:h-80">
              <svg class="w-full h-full" viewBox="0 0 900 300">
                <!-- Grid lines -->
                <defs>
                  <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#e5e7eb" stroke-width="1"/>
                  </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#grid)" />
                
                <!-- Y-axis labels (dynamic scale) -->
                <text x="20" y="20" class="text-xs fill-gray-600">{scale} kn</text>
                <text x="20" y="70" class="text-xs fill-gray-600">{Math.round(scale * 0.75)} kn</text>
                <text x="20" y="120" class="text-xs fill-gray-600">{Math.round(scale * 0.5)} kn</text>
                <text x="20" y="170" class="text-xs fill-gray-600">{Math.round(scale * 0.25)} kn</text>
                <text x="20" y="220" class="text-xs fill-gray-600">0 kn</text>
                
                <!-- Wind speed smooth curve -->
                <path
                  fill="none"
                  stroke="#0891b2"
                  stroke-width="3"
                  d={windPath}
                />
                
                <!-- Wind gusts smooth curve -->
                <path
                  fill="none"
                  stroke="#dc2626"
                  stroke-width="2"
                  stroke-dasharray="5,5"
                  d={gustPath}
                />
                
                <!-- Time labels -->
                {hours.map((hour, index) => {
                  // Show every 2nd hour, but ensure we don't have duplicates
                  const shouldShow = index % 2 === 0;
                  if (shouldShow) {
                    const x = 60 + (index * (780 / (hours.length - 1))); // More space for labels
                    return (
                      <text key={index} x={x} y="295" class="text-xs fill-gray-600" text-anchor="middle">
                        {hour.time}
                      </text>
                    );
                  }
                  return null;
                })}
                
                <!-- Legend -->
                <g transform="translate(650, 20)">
                  <line x1="0" y1="0" x2="30" y2="0" stroke="#0891b2" stroke-width="3"/>
                  <text x="35" y="5" class="text-xs fill-gray-700">Windsnelheid</text>
                  <line x1="0" y1="15" x2="30" y2="15" stroke="#dc2626" stroke-width="2" stroke-dasharray="5,5"/>
                  <text x="35" y="20" class="text-xs fill-gray-700">Windvlagen</text>
                </g>
              </svg>
            </div>
          </div>

          <!-- Hourly Details -->
          <div class="bg-white rounded-xl p-4 sm:p-6 shadow-sm border border-cyan-100">
            <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4">
              Uurlijkse details
            </h2>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="text-left py-2 px-1">Tijd</th>
                    <th class="text-center py-2 px-1">Wind</th>
                    <th class="text-center py-2 px-1">Windvlaag</th>
                    <th class="text-center py-2 px-1">Richting</th>
                    <th class="text-center py-2 px-1">Golfhoogte</th>
                    <th class="text-center py-2 px-1">Neerslag</th>
                  </tr>
                </thead>
                <tbody>
                  {hours.map((hour, index) => {
                    const windSpeed = Math.round(hour.speed || 0);
                    const windColor = windSpeed < 13 ? 'text-cyan-300' : windSpeed < 16 ? 'text-blue-500' : 'text-green-500';
                    const windDir = hour.dir || 0;
                    const rotation = (windDir + 180) % 360;
                    
                    return (
                      <tr key={index} class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-2 px-1 font-medium">{hour.time}</td>
                        <td class={`py-2 px-1 text-center font-semibold ${windColor}`}>
                          {windSpeed} kn
                        </td>
                        <td class="py-2 px-1 text-center text-gray-600">
                          {Math.round(hour.gust || 0)} kn
                        </td>
                        <td class="py-2 px-1 text-center">
                          <div class="inline-block transform" style={`transform: rotate(${rotation}deg)`}>
                            ↑
                          </div>
                        </td>
                        <td class="py-2 px-1 text-center text-gray-600">
                          {hour.waveHeight ? `${hour.waveHeight}m` : '-'}
                        </td>
                        <td class="py-2 px-1 text-center text-gray-600">
                          {hour.rain || 0}mm
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      ) : (
        <div class="bg-white rounded-xl p-8 text-center shadow-sm border border-cyan-100">
          <h2 class="text-xl font-semibold text-gray-800 mb-2">Geen data beschikbaar</h2>
          <p class="text-gray-600">Er zijn geen voorspellingsgegevens beschikbaar voor deze dag.</p>
          <a href={`/${spotId}`} class="inline-block mt-4 bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition-colors">
            Terug naar weekoverzicht
          </a>
        </div>
      )}
    </main>
  </body>
</html>
